# RakuDrop Clone システムアーキテクチャ

## 全体構成

```
+----------------+      QRコード      +----------------+
|    PC側UI      | <----------------- |   スマホ側UI    |
| (index.html)   |                   | (upload.html)   |
+----------------+                   +----------------+
        |                                    |
        | セッションID                        | ファイルアップロード
        |                                    |
+-------v----+                      +--------v-------+
| Realtime   |                      |   Firebase     |
| Database   | <-------------------- |   Storage     |
+------------+                      +----------------+
        |                                    |
        | ファイル情報                        | 保存済みファイル
        |                                    |
+-------v-----------------------------v-------+
|           Firebase Functions               |
|      (24時間後の自動ファイル削除)           |
+------------------------------------------+
```

## コンポーネント詳細

### 1. PC側UI (index.html)
- **機能**:
  - セッションIDの生成
  - QRコードの表示
  - アップロードされたファイルリストの表示
  - ダウンロードリンクの提供
- **技術**:
  - HTML/CSS/JavaScript
  - QRCode.js ライブラリ
  - Firebase SDK (Realtime Database)

### 2. スマホ側UI (upload.html)
- **機能**:
  - ファイル選択インターフェース
  - アップロード進捗表示
  - 完了通知
- **技術**:
  - HTML/CSS/JavaScript (モバイル対応)
  - Firebase SDK (Storage, Realtime Database)

### 3. Firebase Realtime Database
- **構造**:
  ```
  /files
    /{sessionId}
      /{fileId}
        - name: "filename.jpg"
        - url: "https://storage.googleapis.com/..."
        - size: 1024000
        - type: "image/jpeg"
        - timestamp: 1717545123456
  ```
- **用途**:
  - セッション管理
  - ファイルメタデータ保存
  - リアルタイム通知

### 4. Firebase Storage
- **構造**:
  ```
  /uploads/{sessionId}/{fileId}_{filename}
  ```
- **用途**:
  - 実際のファイルデータ保存
  - ダウンロードURL生成

### 5. Firebase Functions
- **機能**:
  - 定期的なクリーンアップ処理
  - 24時間以上経過したファイルの自動削除
  - データベースエントリの削除

## データフロー

1. **セッション開始**:
   - PC側でセッションID生成
   - QRコード内にセッションIDとURLを埋め込み

2. **ファイル転送**:
   - スマホがQRコードをスキャン
   - スマホ側UIがセッションIDを取得
   - ファイル選択・アップロード
   - Storage にファイル保存
   - ダウンロードURLの生成
   - Realtime Database にメタデータ保存

3. **ファイル受信**:
   - PC側がRealtime Database の変更を監視
   - 新しいファイルが追加されたら通知
   - ダウンロードリンクを表示

4. **自動削除**:
   - Firebase Functions が定期的に実行
   - 24時間以上経過したファイルを検出
   - Storage からファイル削除
   - Realtime Database からメタデータ削除

## セキュリティ考慮事項

1. **セッションID**:
   - ランダムな6文字の英数字
   - 推測困難な一意のID

2. **ファイルアクセス**:
   - Storage セキュリティルールでセッションID検証
   - 適切なCORS設定

3. **データベースアクセス**:
   - Realtime Database セキュリティルールで権限制御
   - セッションIDに基づくアクセス制限

## 最適化ポイント

1. **リソース使用量の最小化**:
   - 必要最小限のメタデータのみ保存
   - 不要なリアルタイム更新を避ける
   - 自動削除による不要データの蓄積防止

2. **パフォーマンス**:
   - 軽量なライブラリ使用
   - 効率的なデータ構造
   - 必要な時のみデータベース接続
